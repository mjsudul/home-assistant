# This is a template for the Sonoff S31 devices that use an ESP8266 microprocessor. 
# Replace the fields enclosed in double angle brackets <<value>> with the actual device values from the device's 
# default config.yaml file generated when the device is created by the HomeAssistant ESPHome add-in. 
# Do not include the double angle brackets # in the actual config file.

# ESPHome device definition
esphome:
  name: <<my-device-name>>  # Unique device ID used in ESPHome and Home Assistant
  friendly_name: <<My Device Friendly Name>>  # Human-readable name shown in Home Assistant UI

# Define the microcontroller type (ESP8266 with 1MB flash)
esp8266:
  board: esp01_1m

# Disable UART logging to avoid conflicts with the CSE7766 power monitoring chip
logger:
  baud_rate: 0  # Disables serial logging to free up UART for sensor communication

# Enable Home Assistant native API with encryption
api:
  encryption:
    key: "<<the actual encryption key>>"  # Replace with the key generated by ESPHome

# Enable OTA (Over-the-Air) firmware updates
ota:
  - platform: esphome
    password: "<<the actual password>>"  # Replace with your OTA update password

# Wi-Fi configuration
wifi:
  ssid: !secret wifi_ssid  # Wi-Fi SSID stored in secrets.yaml
  password: !secret wifi_password  # Wi-Fi password stored in secrets.yaml

  # Fallback access point if Wi-Fi fails (useful for recovery)
  ap:
    ssid: "<<the actual fallback SSID>>"  # Temporary AP name
    password: "<<>the actual fallback hotspot password>"  # Temporary AP password

# Enables captive portal for fallback AP
captive_portal:

# UART configuration for CSE7766 power monitoring chip
uart:
  rx_pin: RX  # Receive pin connected to the CSE7766 chip
  baud_rate: 4800  # Required baud rate for CSE7766
  parity: EVEN  # CSE7766 requires even parity

# Binary sensors
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0  # Physical button on the Sonoff S31
      mode: INPUT_PULLUP
      inverted: True
    name: "button"
    on_press:
      - switch.toggle: relay  # Toggle the relay when the button is pressed

  - platform: status
    name: "status"  # Reports whether the device is online or offline

# Sensors for power monitoring and diagnostics
sensor:
  - platform: wifi_signal
    name: "wifi_signal"  # Reports Wi-Fi signal strength in dBm
    update_interval: 60s

  - platform: cse7766  # Reads data from the power monitoring chip
    current:
      name: "current"  # Current in amps
      accuracy_decimals: 1
    voltage:
      name: "voltage"  # Voltage in volts
      accuracy_decimals: 1
    power:
      name: "power"  # Power in watts
      accuracy_decimals: 1
      id: power  # Used for energy calculations

  - platform: integration
    name: "energy"  # Total energy usage over time
    sensor: power  # Uses the power sensor above
    time_unit: h
    state_class: measurement
    unit_of_measurement: kWh
    filters:
      - multiply: 0.001  # Convert from watt-hours to kilowatt-hours

  - platform: total_daily_energy
    name: "Total Daily Energy"  # Resets daily energy usage every 24 hours
    power_id: power

# Time synchronization using SNTP
time:
  - platform: sntp
    id: the_time  # Required for energy tracking and time-based automations

# Relay switch control
switch:
  - platform: gpio
    name: "relay"  # Controls the power outlet
    pin: GPIO12  # Relay control pin
    id: relay
    restore_mode: ALWAYS_ON  # Keeps relay on after reboot (adjust as needed)

# Status LED configuration
status_led:
  pin: GPIO13  # Green LED on the Sonoff S31 to indicate device status
